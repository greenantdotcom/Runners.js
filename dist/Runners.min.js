;(function(window) {'use strict';var Runners = {};var Workers = {};function identity(t){return t}function remove(t,e){var i=t.indexOf(e);i>=0&&t.splice(i,1)}function combineArgs(t,e){for(var i=0;e.length>i;++i){var r=e[i];Array.isArray(r)?t=t.concat(r):t.push(r)}return t}function combine(t,e){return Array.isArray(e)?t=this._doneCbs.concat(e):null!=e&&t.push(e),t}function createPublicInterface(t){var e={};for(var i in t){var r=t[i];"function"==typeof r&&"_"!==i[0]&&(e[i]=r.bind(t))}return e}function extend(t,e){for(var i in e)void 0===t[i]&&(t[i]=e[i]);return t}function normalizeArgs(t,e,i,r){return"function"==typeof t?(i=t,r=e,e=null,t=null):Array.isArray(t)||"object"!=typeof t?Array.isArray(t)&&"function"==typeof e&&(r=i,i=e,e=null):(r=i,i=e,e=t,t=null),r=r||{},extend(r,optsDefaults),{args:t,context:e,fn:i,opts:r}}var log=function(){var t={};return t.error="console"in self&&"error"in console?function(t){console.error(t)}:function(t){alert(t)},t.log="console"in self&&"log"in console?function(t){console.log(t)}:function(t){alert(t)},t}(),optsDefaults={promise:!0,async:!1,interleave:!1},Promise=function(){function t(t){this._progressCbs=[],this._doneCbs=[],this._failCbs=[],this._interruptCbs=[],t&&this._interruptCbs.push(t),this._doneFilter=identity,this._failFilter=identity,this._state="pending"}return t.prototype={then:function(t,e,i){return this._doneCbs=combine(this._doneCbs,t),this._failCbs=combine(this._failCbs,e),this._progressCbs=combine(this._progressCbs,i),this},done:function(){return"resolved"===this._state?this._callLateArrivals(arguments):"pending"===this._state&&(this._doneCbs=combineArgs(this._doneCbs,arguments)),this},fail:function(){return"rejected"===this._state?this._callLateArrivals(arguments):"pending"===this._state&&(this._failCbs=combineArgs(this._failCbs,arguments)),this},always:function(){return this.done.apply(this,arguments),this.fail.apply(this,arguments),this},progress:function(){return"pending"===this._state&&(this._progressCbs=combineArgs(this._progressCbs,arguments)),this},pipe:function(t,e){switch(this._doneFilter=t||identity,this._failFilter=e||identity,this._state){case"rejected":this._result=this._failFilter(this._result);break;case"resolved":this._result=this._doneFilter(this._result)}return this},interrupt:function(t){return t?this._interruptCbs=combineArgs(this._interruptCbs,arguments):this._interruptCbs.forEach(function(t){try{t()}catch(e){log.error("Error invoking a promise interrupt callback"),log.error(e.stack)}}),this},state:function(){return this._state},_callLateArrivals:function(t){for(var e=0;t.length>e;++e){var i=t[e];Array.isArray(i)?i.forEach(function(t){t(this._result)},this):i(this._result)}},_setState:function(t,e){if("pending"!==this._state)throw"Illegal state transition";switch(this._state=t,t){case"rejected":this._result=this._failFilter(e),this._callFailbacks();break;case"resolved":this._result=this._doneFilter(e),this._callDonebacks();break;default:throw"Illegal state transition"}this._failCbs=[],this._doneCbs=[],this._failFilter=this._doneFilter=identity},_callFailbacks:function(){this._failCbs.forEach(function(t){try{t(this._result)}catch(e){log.error("Error invoking a promise fail callback"),log.error(e.stack)}},this)},_callDonebacks:function(){this._doneCbs.forEach(function(t){try{t(this._result)}catch(e){log.error("Error invoking a promise done callback"),log.error(e.stack)}},this)},_progressMade:function(t){this._progressCbs.forEach(function(e){try{e(t)}catch(i){log.error("Error invoking a promise progress callback"),log.error(i.stack)}},this)}},t}(),LinkedList=function(){function t(){this._head=null,this._tail=null,this._size=0}return t.prototype={pushBack:function(t){++this._size;var e={value:t,next:null,prev:null};return null==this._head?this._head=this._tail=e:(this._tail.next=e,e.prev=this._tail,this._tail=e),e},popBack:function(){--this._size;var t=this._tail;return this._tail=this._tail.prev,null!=this._tail&&(this._tail.next=null),t},popFront:function(){--this._size;var t=this._head;return this._head=this._head.next,this._head.prev=null,t},pushFront:function(t){++this._size;var e={value:t,next:null,prev:null};return null==this._head?this._head=this._tail=e:(this._head.prev=e,e.next=this._head,this._head=e),e},removeWithNode:function(t){if(null==t)throw"Null node";--this._size;var e=t.prev,i=t.next;null!=e&&(e.next=t.next),null!=i&&(i.prev=t.prev),t.next=t.prev=null},add:function(t){return this.pushFront(t)},remove:function(){return this.popBack()},forEach:function(t,e){for(var i=this._head;null!=i;)t.call(e,i.value),i=i.next},clear:function(){this._head=this._tail=null,this._size=0},size:function(){return this._size}},t}(),Queue=function(){function t(t){this._maxSize=null==t?-1:t,this._list=new LinkedList}return t.prototype={add:function(t){if(this.size()==this._maxSize)throw"Queue has reached its limit";this._list.pushFront(t)},remove:function(){return this._list.popBack()},clear:function(){this._list.clear()},full:function(){return 0>this._maxSize?!1:this._list.size()>=this._maxSize},size:function(){return this._list.size()}},t}(),workerFactory={_cfg:{path:"./"},config:function(t){for(var e in t)t.hasOwnProperty(e)&&(this._cfg[e]=t[e]);this._cfg.production&&(log.log=function(){},log.error=function(){})},newFixedRunnerPool:function(t,e,i){return"number"==typeof t&&(i=e,e=t,t=void 0),new RunnerPool(t,new Queue(i),e,e)},newRunner:function(t){return new Runner(t)},Runner:Runner,RunnerPool:RunnerPool,Queue:Queue,LinkedList:LinkedList,PrivatePromise:Promise,createPublicInterface:createPublicInterface},Runner=function(){function t(t){t=workerFactory._cfg.path+"/runnerWebWorker.js"+(t?"#"+t:""),this._worker=new Worker(t),this._worker.onerror=i;var e=new MessageChannel;return this._worker.postMessage("internalComs",[e.port2]),e.port1.onmessage=this._messageReceived.bind(this),this._channel=e,this._invokeId=0,this._promises={},this._readyCbs=[],this.runnables=this.fns={},this.registrations={},this._regCbs=[],this.submit=this.submit.bind(this),this}var e={registration:function(t){if(!this._terminated){var e=this.fns[t.data.name]=this._createInvoker(t.data);this.registrations[t.data.name]=t.data,this._notifyRegCbs(e,t.data)}},completed:function(t){if(!this._terminated){var e=this._promises[t.data.id];delete this._promises[t.data.id],e._setState("resolved",t.data.result)}},failed:function(t){if(!this._terminated){var e=this._promises[t.data.id];delete this._promises[t.data.id],e._setState("rejected",t.data.result)}},ready:function(t){this._terminated||this._ready(t.data.err)},progress:function(t){if(!this._terminated){var e=this._promises[t.data.id];e._progressMade(t.data.data)}}},i=function(){log.error("Possibly could not find runnerWebWorker.  Did you pass a {path: '...'} to Runners.config() that points to the Runners script location?")};return t.prototype={terminate:function(){this._terminated=!0,this._promises={},this._readyCbs=[],this._fns={},this.registrations={},this._regCbs=[],this._worker.terminate()},_messageReceived:function(t){e[t.data.type].call(this,t)},_createInvoker:function(t){var e=this;return function(){var i={type:"invoke",fn:t.name,args:Array.prototype.slice.call(arguments,0)},r=e._submit(i,this.__promise,t.promise);return r?createPublicInterface(r):void 0}},submit:function(t,e,i,r){var s=normalizeArgs(t,e,i,r);return s.type="pass_invoke",this._submit(s)},_submit:function(t,e,i){if(this._terminated)throw"Can't submit to a terminated worker";if(t.id=this._invokeId+=1,"function"==typeof t.fn&&(t.fn=""+t.fn),(i||t.opts&&t.opts.promise)&&(null==e?e=this._promises[t.id]=new Promise:this._promises[t.id]=e),e){var r=this;e.interrupt(function(){r._channel.port1.postMessage({type:"interrupt",id:t.id})})}return this._channel.port1.postMessage(t),e},on:function(t,e){switch(t){case"registration":this._regCbs.push(e);break;case"ready":this.ready(e)}},off:function(t,e){switch(t){case"registration":remove(this._regCbs,e);break;case"ready":remove(this._readyCbs,e)}},ready:function(t){this._isReady?t(this,this._err):this._readyCbs.push(t)},_notifyRegCbs:function(t,e){this._regCbs.forEach(function(i){i(t,e)})},_ready:function(t){this._readyCbs.forEach(function(e){e(this,t)},this),this._isReady=!0,this._err=t,this._readyCbs=[]}},t}(),RunnerPool=function(){function t(t,e,i,r){function s(t,e){a._workerCreated(t,e),++o,o==i&&a._ready()}this._url=t,this._queue=e,this._minWorkers=i,this._maxWorkers=r,this._runningWorkers=new LinkedList,this._idleWorkers=new LinkedList,this._readyCbs=[],this._pendingCreations=0,this._workerCreated=this._workerCreated.bind(this);for(var n=0;i>n;++n)this._createWorker(s);var o=0,a=this}var e="register: function(name, func, [promise=true] [, async=false] [, interleave=false])";return t.prototype={_createWorker:function(t){++this._pendingCreations;var e=new Runner(this._url);return e.ready(t),e},_ready:function(){this._isReady=!0,this._readyCbs.forEach(function(t){t()}),this._readyCbs=[]},ready:function(t){this._isReady?t():this._readyCbs=combineArgs(this._readyCbs,arguments)},_workerCreated:function(t,e){--this._pendingCreations,e?(log.error(this._url+": Error adding worker."),log.error(e)):this._terminated?t.terminate():(this.fns||this._createFns(t),this._workerCompleted(t))},_createFns:function(t){this.fns={};var e=this;for(var i in t.fns){var r=t.registrations[i];this.fns[i]=function(i,r){return function(){return e._submit({fn:t.fns[r],opts:i,args:arguments})}}(r,i)}this.runnables=this.fns},submit:function(t,e,i,r){var s=normalizeArgs(t,e,i,r);return s.type="pass_invoke",this._isReady?this._submit(s):(s.promise=new Promise,this._queue.add(s),s.promise)},_submit:function(t){if(!t.opts.promise)throw this._url+": All functions used in a PWorkerPool must return"+" a promise.  Check your function registration. "+e;var i=null,r=null;if(this._idleWorkers.size()>0){r=this._idleWorkers.remove().value;var s=this._dispatchToWorker(r,t);i=s}else this._maxWorkers>this.numWorkers()?(i=t.promise=new Promise,this._queue.add(t),this._createWorker(this._workerCreated)):(i=t.promise=new Promise,this._queue.add(t));return createPublicInterface(i)},_workerCompleted:function(t){if(this._queue.size()>0){var e=this._queue.remove().value;this._dispatchToWorker(t,e)}else t.runningNode?(this._runningWorkers.removeWithNode(t.runningNode),t.runningNode=null,this._idleWorkers.pushFront(t)):this._idleWorkers.add(t)},numWorkers:function(){return this._idleWorkers.size()+this._runningWorkers.size()+this._pendingCreations},queueSize:function(){return this._queue.size()},_dispatchToWorker:function(t,e){t.runningNode=this._runningWorkers.add(t);var i;try{if("pass_invoke"===e.type)i=e.promise,delete e.promise,i=t._submit(e,i);else var i=e.fn.apply({__promise:e.promise},e.args);var r=this;i.always(function(){r._workerCompleted(t,e.opts)})}catch(s){i="Failed dispatching task to worker",log.error(i),log.error(s.stack),this._workerCompleted(t)}return i},terminate:function(){this._queue.clear(),this._runningWorkers.forEach(function(t){t.terminate()},this),this._idleWorkers.forEach(function(t){t.terminate()},this),this._runningWorkers.clear(),this._idleWorkers.clear(),this._terminated=!0}},t}();"undefined"!=typeof define?define(function(){return workerFactory}):"undefined"!=typeof exports?exports=workerFactory:window.Runners=workerFactory;}(this));